<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Bo Burla">
<meta name="dcterms.date" content="2025-09-17">

<title>PHM5002: Metabolomics Data Preprocessing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="PHM5002-Tutorial_files/libs/clipboard/clipboard.min.js"></script>
<script src="PHM5002-Tutorial_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="PHM5002-Tutorial_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="PHM5002-Tutorial_files/libs/quarto-html/popper.min.js"></script>
<script src="PHM5002-Tutorial_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="PHM5002-Tutorial_files/libs/quarto-html/anchor.min.js"></script>
<link href="PHM5002-Tutorial_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="PHM5002-Tutorial_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="PHM5002-Tutorial_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="PHM5002-Tutorial_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="PHM5002-Tutorial_files/libs/bootstrap/bootstrap-769b268fb290e116fe386cf5612ac759.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">1. Introduction</a></li>
  <li><a href="#loading-r-packages" id="toc-loading-r-packages" class="nav-link" data-scroll-target="#loading-r-packages">2. Loading R packages</a></li>
  <li><a href="#importing-raw-data" id="toc-importing-raw-data" class="nav-link" data-scroll-target="#importing-raw-data">3. Importing raw data</a></li>
  <li><a href="#preparing-the-data-data-wrangling" id="toc-preparing-the-data-data-wrangling" class="nav-link" data-scroll-target="#preparing-the-data-data-wrangling">4. Preparing the Data (Data Wrangling)</a></li>
  <li><a href="#example-workflow" id="toc-example-workflow" class="nav-link" data-scroll-target="#example-workflow">Example Workflow</a>
  <ul class="collapse">
  <li><a href="#subset-the-data" id="toc-subset-the-data" class="nav-link" data-scroll-target="#subset-the-data">5. Subset the data</a></li>
  <li><a href="#a-first-look-into-the-data" id="toc-a-first-look-into-the-data" class="nav-link" data-scroll-target="#a-first-look-into-the-data">6. A first look into the data</a></li>
  <li><a href="#assessing-linearity-of-measurements" id="toc-assessing-linearity-of-measurements" class="nav-link" data-scroll-target="#assessing-linearity-of-measurements">7. Assessing Linearity of Measurements</a></li>
  <li><a href="#normalization-and-quantification" id="toc-normalization-and-quantification" class="nav-link" data-scroll-target="#normalization-and-quantification">8. Normalization and Quantification</a></li>
  <li><a href="#inspecting-the-normalized-data" id="toc-inspecting-the-normalized-data" class="nav-link" data-scroll-target="#inspecting-the-normalized-data">9. Inspecting the Normalized Data</a></li>
  <li><a href="#drift-and-batch-correction" id="toc-drift-and-batch-correction" class="nav-link" data-scroll-target="#drift-and-batch-correction">10. Drift and Batch Correction</a></li>
  <li><a href="#calculate-quality-control-qc-metrics" id="toc-calculate-quality-control-qc-metrics" class="nav-link" data-scroll-target="#calculate-quality-control-qc-metrics">11. Calculate Quality Control (QC) Metrics</a></li>
  <li><a href="#feature-filtering" id="toc-feature-filtering" class="nav-link" data-scroll-target="#feature-filtering">12. Feature Filtering</a></li>
  <li><a href="#principal-component-analysis-pca" id="toc-principal-component-analysis-pca" class="nav-link" data-scroll-target="#principal-component-analysis-pca">13. Principal Component Analysis (PCA)</a></li>
  <li><a href="#exclusion-of-an-outlier-sample" id="toc-exclusion-of-an-outlier-sample" class="nav-link" data-scroll-target="#exclusion-of-an-outlier-sample">14. Exclusion of an Outlier Sample</a></li>
  <li><a href="#saving-the-final-dataset" id="toc-saving-the-final-dataset" class="nav-link" data-scroll-target="#saving-the-final-dataset">15. Saving the Final Dataset</a></li>
  </ul></li>
  <li><a href="#processing-the-full-dataset" id="toc-processing-the-full-dataset" class="nav-link" data-scroll-target="#processing-the-full-dataset">Processing the Full Dataset</a>
  <ul class="collapse">
  <li><a href="#data-postprocessing-full-dataset" id="toc-data-postprocessing-full-dataset" class="nav-link" data-scroll-target="#data-postprocessing-full-dataset">16. Data Postprocessing (Full Dataset)</a></li>
  <li><a href="#inspecting-normalized-data-full-dataset" id="toc-inspecting-normalized-data-full-dataset" class="nav-link" data-scroll-target="#inspecting-normalized-data-full-dataset">17. Inspecting Normalized Data (Full Dataset)</a></li>
  <li><a href="#qc-filtering-full-dataset" id="toc-qc-filtering-full-dataset" class="nav-link" data-scroll-target="#qc-filtering-full-dataset">18. QC-Filtering (Full Dataset)</a></li>
  <li><a href="#principal-component-analysis-full-dataset" id="toc-principal-component-analysis-full-dataset" class="nav-link" data-scroll-target="#principal-component-analysis-full-dataset">19. Principal Component Analysis (Full Dataset)</a></li>
  <li><a href="#saving-final-dataset-full-dataset" id="toc-saving-final-dataset-full-dataset" class="nav-link" data-scroll-target="#saving-final-dataset-full-dataset">20. Saving Final Dataset (Full Dataset)</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="PHM5002-Tutorial.docx"><i class="bi bi-file-word"></i>MS Word</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">PHM5002: Metabolomics Data Preprocessing</h1>
<p class="subtitle lead">From Raw Data to Reliable Analytical Results</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Bo Burla </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Singapore Lipidomics Incubator, NUS
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 17, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div id="cell-1" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">collapse =</span> <span class="cn">TRUE</span>, <span class="at">echo =</span> <span class="cn">TRUE</span>, <span class="at">message =</span> <span class="cn">TRUE</span>, <span class="at">warning =</span> <span class="cn">FALSE</span>, <span class="at">fig.height=</span><span class="dv">4</span>, <span class="at">fig.width=</span><span class="dv">10</span>, <span class="at">fig.retina=</span><span class="dv">2</span>, <span class="at">comment =</span> <span class="st">"#&gt;"</span>, <span class="at">fig.show =</span> <span class="st">"hold"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">1. Introduction</h2>
<p>Welcome to this R-based tutorial on data processing of a targeted plasma lipidomics dataset. We will use the dataset published by <a href="https://www.ahajournals.org/doi/10.1161/ATVBAHA.121.316847">Tan et al., <em>Arterioscler Thromb Vasc Biol</em>, 2022</a> as an example. In that study, a panel of 413 plasma lipids was quantified by liquid chromatography–tandem mass spectrometry (LC–MS/MS) using multiple reaction monitoring (MRM). We begin with preprocessed LC-MS raw data, i.e., peak-area data that were generated using the MRMkit software (<a href="https://dx.doi.org/10.1021/acs.analchem.0c03060">Teo et al., <em>Anal. Chem.,</em> 2020</a>). See Figure 1 for an overview of the typical data processing flow, of which we will cover aspects of the postprocessing, quality control and reporting.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/workflow.png" class="img-fluid figure-img" width="319"></p>
<figcaption><strong>Figure 1</strong>: Data Processing Overview</figcaption>
</figure>
</div>
</section>
<section id="loading-r-packages" class="level2">
<h2 class="anchored" data-anchor-id="loading-r-packages">2. Loading R packages</h2>
<p>We will use several packages from the <a href="https://www.tidyverse.org"><code>tidyverse</code></a> for this tutorial. The <a href="https://here.r-lib.org"><code>here</code></a> package will be used to tracking data file paths. Furthermore, we define the point colors and shapes for the QC sample types, which will be used later in the plots.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>NOTE: It is a good practice to restart R before you run or rerun code to clear all loaded data and variables. This can be done via <em>Session -&gt; Restart R</em> or via SHIFT-ALT-0 (Windows) or SHIFT-⌘-0 (MacOS).</p>
</div>
</div>
<div id="cell-4" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>here<span class="sc">::</span><span class="fu">i_am</span>(<span class="st">"PHM5002-Tutorial.qmd"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define point colors and shapes for each qc_type in the plots</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>qc_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">SAMPLE =</span> <span class="st">"grey50"</span>, <span class="at">QC =</span> <span class="st">"red"</span>, <span class="at">BLANK =</span> <span class="st">"#00db7c"</span>, <span class="at">RESP =</span> <span class="st">"blue"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>qc_shapes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">SAMPLE =</span> <span class="dv">1</span>, <span class="at">QC =</span> <span class="dv">21</span>, <span class="at">BLANK =</span> <span class="dv">23</span>, <span class="at">RESP =</span> <span class="dv">22</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre>── <span class="ansi-bold">Attaching core tidyverse packages</span> ─────────────────────────────────────────────────────────────── tidyverse 2.0.0 ──

<span class="ansi-green-fg">✔</span> <span class="ansi-blue-fg">dplyr    </span> 1.1.4     <span class="ansi-green-fg">✔</span> <span class="ansi-blue-fg">readr    </span> 2.1.5

<span class="ansi-green-fg">✔</span> <span class="ansi-blue-fg">forcats  </span> 1.0.0     <span class="ansi-green-fg">✔</span> <span class="ansi-blue-fg">stringr  </span> 1.5.1

<span class="ansi-green-fg">✔</span> <span class="ansi-blue-fg">ggplot2  </span> 3.5.2     <span class="ansi-green-fg">✔</span> <span class="ansi-blue-fg">tibble   </span> 3.3.0

<span class="ansi-green-fg">✔</span> <span class="ansi-blue-fg">lubridate</span> 1.9.4     <span class="ansi-green-fg">✔</span> <span class="ansi-blue-fg">tidyr    </span> 1.3.1

<span class="ansi-green-fg">✔</span> <span class="ansi-blue-fg">purrr    </span> 1.1.0     

── <span class="ansi-bold">Conflicts</span> ───────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──

<span class="ansi-red-fg">✖</span> <span class="ansi-blue-fg">dplyr</span>::<span class="ansi-green-fg">filter()</span> masks <span class="ansi-blue-fg">stats</span>::filter()

<span class="ansi-red-fg">✖</span> <span class="ansi-blue-fg">dplyr</span>::<span class="ansi-green-fg">lag()</span>    masks <span class="ansi-blue-fg">stats</span>::lag()

<span class="ansi-cyan-fg">ℹ</span> Use the conflicted package (<span style="font-style:italic" class="ansi-blue-fg">&lt;http://conflicted.r-lib.org/&gt;</span>) to force all conflicts to become errors

here() starts at /Users/lsibjb/Documents/Code/PHM5002



here() starts at /Users/lsibjb/Documents/Code/PHM5002


</pre>
</div>
</div>
</div>
</section>
<section id="importing-raw-data" class="level2">
<h2 class="anchored" data-anchor-id="importing-raw-data">3. Importing raw data</h2>
<p>We begin by loading the table containing peak area data. After import, it is important to verify that the data were loaded correctly, completely, and with appropriate column types. Missing values or undefined text entries can cause columns to be interpreted as character rather than numeric data.</p>
<div id="cell-6" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>d_orig <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="fu">here</span>(<span class="st">"data/SPERFECT_RawAreas_Tutorial.csv"</span>),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">trim_ws =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">na =</span> <span class="fu">c</span>(<span class="st">"NA"</span>, <span class="st">"ND"</span>, <span class="st">"n.d."</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d_orig)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre><span class="ansi-bold">Rows: </span><span class="ansi-blue-fg">445</span> <span class="ansi-bold">Columns: </span><span class="ansi-blue-fg">416</span>

<span class="ansi-cyan-fg">──</span> <span class="ansi-bold">Column specification</span> <span class="ansi-cyan-fg">───────────────────────────────────────────────────────────────────────────────────────────────</span>

<span class="ansi-bold">Delimiter:</span> ","

<span class="ansi-red-fg">chr</span>   (3): filename, batch_id, qc_type

<span class="ansi-green-fg">dbl</span> (413): CE 14:0, CE 15:0, CE 16:0, CE 16:1, CE 16:2, CE 17:0, CE 17:1, CE...



<span class="ansi-cyan-fg">ℹ</span> Use `spec()` to retrieve the full column specification for this data.

<span class="ansi-cyan-fg">ℹ</span> Specify the column types or set `show_col_types = FALSE` to quiet this message.
</pre>
</div>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A tibble: 6 × 416</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">filename</th>
<th data-quarto-table-cell-role="th" scope="col">batch_id</th>
<th data-quarto-table-cell-role="th" scope="col">qc_type</th>
<th data-quarto-table-cell-role="th" scope="col">CE 14:0</th>
<th data-quarto-table-cell-role="th" scope="col">CE 15:0</th>
<th data-quarto-table-cell-role="th" scope="col">CE 16:0</th>
<th data-quarto-table-cell-role="th" scope="col">CE 16:1</th>
<th data-quarto-table-cell-role="th" scope="col">CE 16:2</th>
<th data-quarto-table-cell-role="th" scope="col">CE 17:0</th>
<th data-quarto-table-cell-role="th" scope="col">CE 17:1</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">TG 54:5 [-18:1]</th>
<th data-quarto-table-cell-role="th" scope="col">TG 54:5 [SIM]</th>
<th data-quarto-table-cell-role="th" scope="col">TG 54:6 [-18:2]</th>
<th data-quarto-table-cell-role="th" scope="col">TG 54:6 [SIM]</th>
<th data-quarto-table-cell-role="th" scope="col">TG 56:6 [-20:4]</th>
<th data-quarto-table-cell-role="th" scope="col">TG 56:6 [SIM]</th>
<th data-quarto-table-cell-role="th" scope="col">TG 56:8 [-20:4]</th>
<th data-quarto-table-cell-role="th" scope="col">TG 56:8 [SIM]</th>
<th data-quarto-table-cell-role="th" scope="col">TG 58:8 [-22:6]</th>
<th data-quarto-table-cell-role="th" scope="col">TG 58:8 [SIM]</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">⋯</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>PBLK-1.mzML</td>
<td>Longit_1</td>
<td>BLANK</td>
<td>47.33668</td>
<td>54.56039</td>
<td>440.0968</td>
<td>143.0343</td>
<td>0.5681131</td>
<td>19.40112</td>
<td>96.85926</td>
<td>⋯</td>
<td>8273.105</td>
<td>201962.4</td>
<td>5808.207</td>
<td>20293.35</td>
<td>290.864</td>
<td>49109.9</td>
<td>35.01584</td>
<td>8720.705</td>
<td>213.0995</td>
<td>2249.682</td>
</tr>
<tr class="even">
<td>RQC-1-10.mzML</td>
<td>Longit_1</td>
<td>RESP</td>
<td>87.33454</td>
<td>261.53584</td>
<td>23403.8998</td>
<td>3270.6534</td>
<td>248.0368257</td>
<td>389.76839</td>
<td>518.20070</td>
<td>⋯</td>
<td>373829.748</td>
<td>2534052.1</td>
<td>93339.281</td>
<td>941357.33</td>
<td>69638.046</td>
<td>1480249.6</td>
<td>9985.41028</td>
<td>250356.573</td>
<td>15229.3103</td>
<td>134253.815</td>
</tr>
<tr class="odd">
<td>RQC-1-20.mzML</td>
<td>Longit_1</td>
<td>RESP</td>
<td>209.87036</td>
<td>530.44076</td>
<td>37327.1658</td>
<td>4810.9088</td>
<td>226.1989196</td>
<td>1212.11771</td>
<td>1450.79610</td>
<td>⋯</td>
<td>672990.110</td>
<td>5390233.7</td>
<td>218274.112</td>
<td>2246087.24</td>
<td>147754.422</td>
<td>2052751.2</td>
<td>23144.64829</td>
<td>686224.021</td>
<td>37198.1048</td>
<td>257961.551</td>
</tr>
<tr class="even">
<td>RQC-1-40.mzML</td>
<td>Longit_1</td>
<td>RESP</td>
<td>335.09201</td>
<td>186.37977</td>
<td>52478.4768</td>
<td>4923.1994</td>
<td>307.3759717</td>
<td>1133.24989</td>
<td>947.66596</td>
<td>⋯</td>
<td>1212039.112</td>
<td>8193359.5</td>
<td>347357.885</td>
<td>3131958.55</td>
<td>230409.021</td>
<td>2790798.1</td>
<td>39653.88664</td>
<td>1086392.043</td>
<td>63722.4765</td>
<td>503483.224</td>
</tr>
<tr class="odd">
<td>RQC-1-60.mzML</td>
<td>Longit_1</td>
<td>RESP</td>
<td>188.84420</td>
<td>239.20994</td>
<td>66109.3650</td>
<td>5773.6374</td>
<td>416.7962786</td>
<td>1459.16631</td>
<td>1122.55653</td>
<td>⋯</td>
<td>1539370.900</td>
<td>11346953.8</td>
<td>570166.970</td>
<td>4491704.46</td>
<td>287020.003</td>
<td>4112225.6</td>
<td>56616.51697</td>
<td>1315912.982</td>
<td>81560.8181</td>
<td>596156.877</td>
</tr>
<tr class="even">
<td>RQC-1-80.mzML</td>
<td>Longit_1</td>
<td>RESP</td>
<td>591.90719</td>
<td>230.05679</td>
<td>75214.4665</td>
<td>6100.4509</td>
<td>256.2172797</td>
<td>1852.43953</td>
<td>803.07129</td>
<td>⋯</td>
<td>2073486.183</td>
<td>15600101.5</td>
<td>627310.867</td>
<td>5677476.78</td>
<td>360325.219</td>
<td>4660248.1</td>
<td>63213.91273</td>
<td>1673236.053</td>
<td>100971.5542</td>
<td>738767.093</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="preparing-the-data-data-wrangling" class="level2">
<h2 class="anchored" data-anchor-id="preparing-the-data-data-wrangling">4. Preparing the Data (Data Wrangling)</h2>
<p>First, we will rearrange the imported dataset for the subsequent steps. We remove the <code>.mzML</code> file extension from the entries in the <code>sample_id</code> column, which will then be renamed to <code>sample_id</code>. Furthermore, we will add a column containing the analysis order number (<code>run_no</code>), assuming the imported data were in the actual analysis sequence. In the second step, we will convert the data into a <em>long format</em>. In this format, each observation (a unique sample/lipid pair) uses a single row. Columns then represent the measured variables for that observation, such as peak area or retention time.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/wide-long-table.png" class="img-fluid figure-img" width="467"></p>
<figcaption><strong>Figure 2</strong>: Comparison of Wide vs.&nbsp;Long-Format Tables. The column shown in red is an additional feature variable not available in the wide table.</figcaption>
</figure>
</div>
<div id="cell-data-wrangling" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>d_orig <span class="ot">&lt;-</span> d_orig <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">filename =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(filename, <span class="st">".mzML"</span>, <span class="st">""</span>)) <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">run_no =</span> <span class="fu">row_number</span>(), <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>d_full <span class="ot">&lt;-</span> d_orig <span class="sc">|&gt;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"lipid"</span>, </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"area"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span>run_no<span class="sc">:-</span>qc_type</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(lipid) <span class="sc">|&gt;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">sample_id =</span> filename)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d_full)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="data-wrangling" class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A tibble: 6 × 6</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">run_no</th>
<th data-quarto-table-cell-role="th" scope="col">sample_id</th>
<th data-quarto-table-cell-role="th" scope="col">batch_id</th>
<th data-quarto-table-cell-role="th" scope="col">qc_type</th>
<th data-quarto-table-cell-role="th" scope="col">lipid</th>
<th data-quarto-table-cell-role="th" scope="col">area</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>PBLK-1</td>
<td>Longit_1</td>
<td>BLANK</td>
<td>CE 14:0</td>
<td>47.33668</td>
</tr>
<tr class="even">
<td>2</td>
<td>RQC-1-10</td>
<td>Longit_1</td>
<td>RESP</td>
<td>CE 14:0</td>
<td>87.33454</td>
</tr>
<tr class="odd">
<td>3</td>
<td>RQC-1-20</td>
<td>Longit_1</td>
<td>RESP</td>
<td>CE 14:0</td>
<td>209.87036</td>
</tr>
<tr class="even">
<td>4</td>
<td>RQC-1-40</td>
<td>Longit_1</td>
<td>RESP</td>
<td>CE 14:0</td>
<td>335.09201</td>
</tr>
<tr class="odd">
<td>5</td>
<td>RQC-1-60</td>
<td>Longit_1</td>
<td>RESP</td>
<td>CE 14:0</td>
<td>188.84420</td>
</tr>
<tr class="even">
<td>6</td>
<td>RQC-1-80</td>
<td>Longit_1</td>
<td>RESP</td>
<td>CE 14:0</td>
<td>591.90719</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="example-workflow" class="level1">
<h1>Example Workflow</h1>
<section id="subset-the-data" class="level2">
<h2 class="anchored" data-anchor-id="subset-the-data">5. Subset the data</h2>
<p>We will focus on a selected subset of the measured analytes in this first part of the tutorial for illustrative purposes. For this, few measured triacylglycerol (TG) species and the corresponding internal standard will be selected. The code to process the full dataset can be found at the end of this tutorial (Section 15).</p>
<p>We subset the measured lipid species using <em>regular expressions</em> and include the TG internal standard as well. You can modify the code below to select other lipid species.</p>
<div id="cell-subset-data" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>d_subset <span class="ot">&lt;-</span> d_full <span class="sc">|&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(lipid, <span class="st">"^TG 5[2-9]:[2-8] </span><span class="sc">\\</span><span class="st">[</span><span class="sc">\\</span><span class="st">-"</span>) <span class="sc">|</span> lipid <span class="sc">==</span> <span class="st">"TG 48:1 d7 [-15:0] (ISTD)"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d_subset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="subset-data" class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A tibble: 6 × 6</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">run_no</th>
<th data-quarto-table-cell-role="th" scope="col">sample_id</th>
<th data-quarto-table-cell-role="th" scope="col">batch_id</th>
<th data-quarto-table-cell-role="th" scope="col">qc_type</th>
<th data-quarto-table-cell-role="th" scope="col">lipid</th>
<th data-quarto-table-cell-role="th" scope="col">area</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;int&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>PBLK-1</td>
<td>Longit_1</td>
<td>BLANK</td>
<td>TG 48:1 d7 [-15:0] (ISTD)</td>
<td>2190562.5</td>
</tr>
<tr class="even">
<td>2</td>
<td>RQC-1-10</td>
<td>Longit_1</td>
<td>RESP</td>
<td>TG 48:1 d7 [-15:0] (ISTD)</td>
<td>274380.5</td>
</tr>
<tr class="odd">
<td>3</td>
<td>RQC-1-20</td>
<td>Longit_1</td>
<td>RESP</td>
<td>TG 48:1 d7 [-15:0] (ISTD)</td>
<td>585267.3</td>
</tr>
<tr class="even">
<td>4</td>
<td>RQC-1-40</td>
<td>Longit_1</td>
<td>RESP</td>
<td>TG 48:1 d7 [-15:0] (ISTD)</td>
<td>1018344.5</td>
</tr>
<tr class="odd">
<td>5</td>
<td>RQC-1-60</td>
<td>Longit_1</td>
<td>RESP</td>
<td>TG 48:1 d7 [-15:0] (ISTD)</td>
<td>1236618.1</td>
</tr>
<tr class="even">
<td>6</td>
<td>RQC-1-80</td>
<td>Longit_1</td>
<td>RESP</td>
<td>TG 48:1 d7 [-15:0] (ISTD)</td>
<td>1663751.4</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="a-first-look-into-the-data" class="level2">
<h2 class="anchored" data-anchor-id="a-first-look-into-the-data">6. A first look into the data</h2>
<p>Now we take a first look on how the analysis went. To do this, we inspect the peak areas of over the analysis sequence. Different QC samples were included in this analysis:</p>
<ul>
<li>QC (Quality Controls): Pooled plasma samples, co-extracted with study samples</li>
<li>BLANK (Blanks): Samples without matrix (plasma) to determine background signals</li>
<li>RESP (Response QCs): To check for linear response</li>
</ul>
<div id="cell-plot-runscatter-areas" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_subset, <span class="fu">aes</span>(<span class="at">x =</span> run_no, <span class="at">y =</span> area)) <span class="sc">+</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> qc_type, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">fill =</span> qc_type, </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">shape  =</span> qc_type),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">1</span>, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span><span class="fl">0.7</span>, </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">stroke =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(lipid), </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">ncol =</span> <span class="dv">4</span>, </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">nrow =</span> <span class="dv">4</span>, </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">scales=</span><span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(<span class="at">na.value =</span> <span class="cn">NA</span>, <span class="at">values =</span> qc_shapes) <span class="sc">+</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> qc_colors, <span class="at">na.value =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> qc_colors, <span class="at">na.value =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(d_subset<span class="sc">$</span>run_no), <span class="at">by =</span> <span class="dv">100</span> )) <span class="sc">+</span> </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span> </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">8</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="PHM5002-Tutorial_files/figure-html/plot-runscatter-areas-output-1.png" id="plot-runscatter-areas" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The quality-control (QC) samples (red points) are relatively stable and exhibit low variability throughout the analysis (4 days). This suggests a low analytical variability in the measurement of the shown analytes. In contrast, the study samples (grey) show greater variability, reflecting biological variability in addition to analytical variability.</p>
<div class="line-block">What do you observe for the spiked-in internal standard (top left)? What about the blanks?</div>
</section>
<section id="assessing-linearity-of-measurements" class="level2">
<h2 class="anchored" data-anchor-id="assessing-linearity-of-measurements">7. Assessing Linearity of Measurements</h2>
<p>Analyzed sample amounts need to be carefully chosen when measuring analytes covering a large concentration range. It is a trade-off between sensitivity and not exceeding the linear range of the measurement. Below we plot the response curves and fit linear regression lines to the data. We observe an overall good linearity for most species.</p>
</section>
<section id="normalization-and-quantification" class="level2">
<h2 class="anchored" data-anchor-id="normalization-and-quantification">8. Normalization and Quantification</h2>
<p>To reduce technical variability and convert peak areas to concentrations, we will use internal-standard (ISTD) normalization. Internal standards are compounds with similar chemical/physicochemical properties to the analytes, but are distinguishable in the used assay. Suitable ISTDs include isotope‑labelled versions of the analytes or structurally similar compounds not present in the sample matrix.</p>
<p>Below we iterate over each sample and divide the peak area of each lipid species by the peak area of the corresponding TG class‑specific ISTD in the sample. The normalized areas are stored in a new column <code>norm_area</code>.</p>
<div id="normalize-areas" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>d_subset <span class="ot">&lt;-</span> d_subset <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample_id) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">norm_area =</span> area <span class="sc">/</span> area[lipid <span class="sc">==</span> <span class="st">"TG 48:1 d7 [-15:0] (ISTD)"</span>]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we know how much ISTD was spiked into each sample, we can calculate the concentration of each lipid species using:</p>
<p><span class="math display">\[
[Lipid] = \biggl(\frac{Lipid_i}{ISTD_{class}}\biggr) \biggl(\frac{ISTD_{vol}* [ISTD_{class}]}{Sample_{amount}}\biggr)
\]</span></p>
<p><span class="math inline">\(Lipid_i\)</span> is the peak area of a lipid species, <span class="math inline">\(ISTD_{class}\)</span> is the peak area of the class-specific ISTD used for normalization, <span class="math inline">\(ISTD_{vol}\)</span> is the volume of ISTD solution spiked into the sample, <span class="math inline">\([ISTD_{class}]\)</span> is the concentration of ISTD in the mix, and <span class="math inline">\(Sample_{amount}\)</span> is the amount (volume) of sample extracted.</p>
<p>In our case, 4.5 µL of ISTD solution was spiked into 10 µL plasma, and the concentration of the TG ISTD in the spike-in solution is 70.53 µmol/L. We hence calculate the concentrations as shown below, with the calculated concentrations being stored in the new column <code>concentration</code>. The concentration unit is µmol/L.</p>
<div id="calculate-concentration" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>d_subset <span class="ot">&lt;-</span> d_subset <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sample_id) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">concentration =</span> norm_area <span class="sc">*</span> (<span class="fl">4.5</span> <span class="sc">*</span> <span class="fl">70.53</span>) <span class="sc">/</span> <span class="dv">10</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inspecting-the-normalized-data" class="level2">
<h2 class="anchored" data-anchor-id="inspecting-the-normalized-data">9. Inspecting the Normalized Data</h2>
<p>Normalization with a class-specific ISTD can reduce variability that resulted from sample processing and the LC–MS analysis, but it may also introduce noise or artifacts. Let’s examine how the data look after normalization.</p>
<div id="cell-plot-runscatter-function" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>plot_runscatter <span class="ot">&lt;-</span> <span class="cf">function</span>(data, variable){</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(qc_type, <span class="st">"BLANK|RQC"</span>))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> run_no, <span class="at">y =</span> {{variable}})) <span class="sc">+</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> qc_type, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fill =</span> qc_type, </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">shape  =</span> qc_type),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span><span class="fl">0.7</span>, <span class="at">stroke =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(lipid), </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">ncol =</span> <span class="dv">4</span>, </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">nrow =</span> <span class="dv">4</span>, </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">scales=</span><span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_shape_manual</span>(<span class="at">na.value =</span> <span class="cn">NA</span>, <span class="at">values =</span> qc_shapes) <span class="sc">+</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> qc_colors, <span class="at">na.value =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> qc_colors, <span class="at">na.value =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(d_subset<span class="sc">$</span>run_no), <span class="at">by =</span> <span class="dv">100</span> )) <span class="sc">+</span> </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span> </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">8</span>) </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_runscatter</span>(d_subset, concentration)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="PHM5002-Tutorial_files/figure-html/plot-runscatter-function-output-1.png" id="plot-runscatter-function" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="drift-and-batch-correction" class="level2">
<h2 class="anchored" data-anchor-id="drift-and-batch-correction">10. Drift and Batch Correction</h2>
<p>Some drifts are still present in the data. We will attempt to correct these drifts and batch effects, assuming that the QCs reflect the same drift and batch effects affecting the study samples. First, we apply within-batch <code>loess</code> smoothing.</p>
<p><strong>Note</strong>: In the publication another algorithm was used, which was based on the all data points rather than just QCs.</p>
<div id="drift-correction" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>d_subset<span class="sc">$</span>y_predicted <span class="ot">&lt;-</span> <span class="cn">NULL</span>   <span class="co"># clean up in case chunk is rerun</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a robust loess-based smoothing function</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>get_loess <span class="ot">&lt;-</span> <span class="cf">function</span>(d) {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">run_no =</span> <span class="fu">seq</span>(<span class="fu">min</span>(d<span class="sc">$</span>run_no), <span class="fu">max</span>(d<span class="sc">$</span>run_no), <span class="dv">1</span>))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">loess</span>(</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> <span class="fu">subset</span>(d, qc_type <span class="sc">==</span> <span class="st">"QC"</span>), <span class="at">formula =</span> conc_log <span class="sc">~</span> run_no, <span class="at">span =</span> <span class="fl">0.8</span>) <span class="sc">|&gt;</span> </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>      stats<span class="sc">::</span><span class="fu">predict</span>(dt) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>()</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    res},</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e) {<span class="fu">return</span>(<span class="fu">rep</span>(<span class="cn">NA_real_</span>, <span class="fu">length</span>(d<span class="sc">$</span>run_no)))})</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-transform concentration values to make loess more robust</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>d_subset<span class="sc">$</span>conc_log <span class="ot">&lt;-</span> <span class="fu">log2</span>(d_subset<span class="sc">$</span>concentration ) <span class="co"># log-transform concentration</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate loess fit for each lipid in each batch</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>d_subset <span class="ot">&lt;-</span> d_subset <span class="sc">|&gt;</span> </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lipid, batch_id) <span class="sc">|&gt;</span>  </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">|&gt;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_predicted =</span> purrr<span class="sc">::</span><span class="fu">map</span>(data, \(x) <span class="fu">get_loess</span>(x))) <span class="sc">|&gt;</span> </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(data, y_predicted))</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Smooth study samples based on the loess fit of the QCs and </span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co"># and transform values back to concentration scale</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>d_subset <span class="ot">&lt;-</span> d_subset <span class="sc">|&gt;</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lipid, batch_id) <span class="sc">|&gt;</span> </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_predicted =</span> y_predicted <span class="sc">-</span> <span class="fu">median</span>(y_predicted, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">conc_adj =</span> <span class="dv">2</span><span class="sc">^</span>(conc_log <span class="sc">-</span> y_predicted)) <span class="sc">|&gt;</span> </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s have a look how the data looks after drift correction:</p>
<div id="cell-plot-runscatter-conc" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_runscatter</span>(d_subset, conc_adj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre>Warning message:

“Removed 96 rows containing missing values or values outside the scale range (`geom_point()`).”
</pre>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="PHM5002-Tutorial_files/figure-html/plot-runscatter-conc-output-2.png" id="plot-runscatter-conc" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Next, we apply QC-based median-centering to correct batch effects and plot the data again:</p>
<div id="cell-batch-correction" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Between-batch correction via QC-based median centering</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>d_subset <span class="ot">&lt;-</span> d_subset <span class="sc">|&gt;</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lipid,  batch_id) <span class="sc">|&gt;</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">conc_median =</span> <span class="fu">median</span>(conc_adj[qc_type <span class="sc">==</span> <span class="st">"QC"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">conc_adj =</span> conc_adj<span class="sc">/</span>conc_median</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Rescaling to grand mean</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>d_subset <span class="ot">&lt;-</span> d_subset <span class="sc">|&gt;</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a> <span class="fu">group_by</span>(lipid) <span class="sc">|&gt;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">mutate</span>(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">conc_adj =</span> conc_adj <span class="sc">*</span> <span class="fu">mean</span>(conc_median[qc_type <span class="sc">==</span> <span class="st">"QC"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a> ) <span class="sc">|&gt;</span> </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a> <span class="fu">ungroup</span>()</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_runscatter</span>(d_subset, conc_adj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre>Warning message:

“Removed 96 rows containing missing values or values outside the scale range (`geom_point()`).”
</pre>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="PHM5002-Tutorial_files/figure-html/batch-correction-output-2.png" id="batch-correction" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="line-block">What do you observe? Do you have any concerns with this approach?</div>
</section>
<section id="calculate-quality-control-qc-metrics" class="level2">
<h2 class="anchored" data-anchor-id="calculate-quality-control-qc-metrics">11. Calculate Quality Control (QC) Metrics</h2>
<p>To evaluate the analysis quality and filter the data, we calculate QC metrics for each lipid species. These include the analytical coefficient of variation (%CV) based on the QCs and the signal-to-blank ratio.</p>
<div id="cell-qc-metrics" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cv <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">/</span><span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>d_qc <span class="ot">&lt;-</span> d_subset <span class="sc">|&gt;</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lipid) <span class="sc">|&gt;</span> </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">signal_blank_ratio =</span> <span class="fu">median</span>(area[qc_type <span class="sc">==</span> <span class="st">"SAMPLE"</span>], <span class="at">na.rm  =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">median</span>(area[qc_type <span class="sc">==</span> <span class="st">"BLANK"</span>], <span class="at">na.rm  =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_qc_area =</span> <span class="fu">cv</span>(area[qc_type <span class="sc">==</span> <span class="st">"QC"</span>]),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_qc_concadj =</span> <span class="fu">cv</span>(conc_adj[qc_type <span class="sc">==</span> <span class="st">"QC"</span>]), </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_conc =</span> <span class="fu">mean</span>(conc_adj[qc_type <span class="sc">==</span> <span class="st">"SAMPLE"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  d_qc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="qc-metrics" class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>A tibble: 16 × 5</caption>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" scope="col">lipid</th>
<th data-quarto-table-cell-role="th" scope="col">signal_blank_ratio</th>
<th data-quarto-table-cell-role="th" scope="col">cv_qc_area</th>
<th data-quarto-table-cell-role="th" scope="col">cv_qc_concadj</th>
<th data-quarto-table-cell-role="th" scope="col">mean_conc</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th" scope="col">&lt;chr&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
<th data-quarto-table-cell-role="th" scope="col">&lt;dbl&gt;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>TG 48:1 d7 [-15:0] (ISTD)</td>
<td>0.4692592</td>
<td>9.211315</td>
<td>1.762602e-13</td>
<td>31.738500</td>
</tr>
<tr class="even">
<td>TG 52:2 [-16:0]</td>
<td>103.0617088</td>
<td>7.229633</td>
<td>5.938931e+00</td>
<td>585.605007</td>
</tr>
<tr class="odd">
<td>TG 52:3 [-16:1]</td>
<td>54.0521323</td>
<td>6.914775</td>
<td>5.698375e+00</td>
<td>38.883131</td>
</tr>
<tr class="even">
<td>TG 52:3 [-18:2]</td>
<td>184.2649858</td>
<td>7.981766</td>
<td>7.663653e+00</td>
<td>395.203906</td>
</tr>
<tr class="odd">
<td>TG 52:4 [-16:0]</td>
<td>301.7547458</td>
<td>7.199320</td>
<td>6.814628e+00</td>
<td>157.915959</td>
</tr>
<tr class="even">
<td>TG 52:4 [-18:1]</td>
<td>285.0684618</td>
<td>6.286556</td>
<td>6.096620e+00</td>
<td>73.183703</td>
</tr>
<tr class="odd">
<td>TG 53:2 [-17:0]</td>
<td>65.5161064</td>
<td>10.566126</td>
<td>7.340353e+00</td>
<td>8.610932</td>
</tr>
<tr class="even">
<td>TG 54:2 [-18:0]</td>
<td>55.0606407</td>
<td>8.944523</td>
<td>8.087281e+00</td>
<td>72.528402</td>
</tr>
<tr class="odd">
<td>TG 54:3 [-18:1]</td>
<td>51.6824685</td>
<td>8.909448</td>
<td>6.596849e+00</td>
<td>242.432288</td>
</tr>
<tr class="even">
<td>TG 54:4 [-18:0]</td>
<td>62.7842849</td>
<td>7.198567</td>
<td>5.189386e+00</td>
<td>11.261662</td>
</tr>
<tr class="odd">
<td>TG 54:4 [-18:2]</td>
<td>73.2910611</td>
<td>7.305227</td>
<td>6.222268e+00</td>
<td>21.374081</td>
</tr>
<tr class="even">
<td>TG 54:5 [-18:1]</td>
<td>123.0689947</td>
<td>6.393832</td>
<td>6.099627e+00</td>
<td>56.723106</td>
</tr>
<tr class="odd">
<td>TG 54:6 [-18:2]</td>
<td>115.2129621</td>
<td>13.178465</td>
<td>8.756041e+00</td>
<td>30.106277</td>
</tr>
<tr class="even">
<td>TG 56:6 [-20:4]</td>
<td>363.5044392</td>
<td>6.611241</td>
<td>6.914840e+00</td>
<td>10.646998</td>
</tr>
<tr class="odd">
<td>TG 56:8 [-20:4]</td>
<td>1011.4477135</td>
<td>12.963647</td>
<td>7.861365e+00</td>
<td>3.938585</td>
</tr>
<tr class="even">
<td>TG 58:8 [-22:6]</td>
<td>488.3819518</td>
<td>6.177163</td>
<td>5.823309e+00</td>
<td>8.790630</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="line-block">What do you observe? How do the %CVs compare with clinical diagnostics–grade TG assays?</div>
</section>
<section id="feature-filtering" class="level2">
<h2 class="anchored" data-anchor-id="feature-filtering">12. Feature Filtering</h2>
<p>Next, we exclude features (lipid species) that were not reliably measured, i.e., features that do not meet predefined QC criteria such as acceptable analytical variability and sufficient signal-to-blank ratio. From the QC metrics above, all processed TG species have %CV &lt; 25% and a signal-to-blank ratio &gt; 10. Thus, all measured species meet our QC criteria and will be reported.</p>
<p>See Section 18 below for the results of the feature filtering when applied to the full dataset.</p>
</section>
<section id="principal-component-analysis-pca" class="level2">
<h2 class="anchored" data-anchor-id="principal-component-analysis-pca">13. Principal Component Analysis (PCA)</h2>
<p>As a final step, we generate a PCA plot from the concentration data to assess overall structure and detect any clear outliers that may need to be investigated.</p>
<div class="line-block">What do you observe? What patterns would you expect to see?</div>
<div id="cell-pca" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>plot_pca <span class="ot">&lt;-</span> <span class="cf">function</span>(data, variable) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  d_pca <span class="ot">&lt;-</span> data  <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(qc_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"QC"</span>, <span class="st">"SAMPLE"</span>), <span class="sc">!</span><span class="fu">str_detect</span>(lipid, <span class="st">"ISTD"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sample_id, qc_type, batch_id, lipid, {{variable}}) <span class="sc">|&gt;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"lipid"</span>, <span class="at">values_from =</span> {{variable}}) <span class="sc">|&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="co"># NA rows of rows that could not be smoothed before</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  d_metadata <span class="ot">&lt;-</span> d_pca <span class="sc">|&gt;</span>  <span class="fu">select</span>(sample_id, qc_type, batch_id) <span class="sc">|&gt;</span>  <span class="fu">distinct</span>()</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  m_raw <span class="ot">&lt;-</span> d_pca <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>qc_type, <span class="sc">-</span>batch_id) <span class="sc">|&gt;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">where</span>( <span class="sc">~</span> <span class="sc">!</span><span class="fu">any</span>(<span class="fu">is.na</span>(.)))) <span class="sc">|&gt;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">column_to_rownames</span>(<span class="st">"sample_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>()</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  m_raw <span class="ot">&lt;-</span> <span class="fu">log2</span>(m_raw)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get pca result with annotation</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  pca_res <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(m_raw, <span class="at">scale =</span> <span class="cn">TRUE</span>, <span class="at">center =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  pca_annot <span class="ot">&lt;-</span> pca_res <span class="sc">|&gt;</span> broom<span class="sc">::</span><span class="fu">augment</span>(d_metadata)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  pca_contrib <span class="ot">&lt;-</span> pca_res <span class="sc">|&gt;</span> broom<span class="sc">::</span><span class="fu">tidy</span>(<span class="at">matrix =</span> <span class="st">"eigenvalues"</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> pca_annot,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> .fittedPC1,</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> .fittedPC2,</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> qc_type,</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> qc_type,</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">shape =</span> qc_type,</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="st">"sample_id"</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>,</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>                        <span class="at">linewidth =</span> <span class="fl">0.4</span>,</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>                        <span class="at">color =</span> <span class="st">"grey80"</span>) <span class="sc">+</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>,</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>                        <span class="at">linewidth =</span> <span class="fl">0.4</span>,</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>                        <span class="at">color =</span> <span class="st">"grey80"</span>) <span class="sc">+</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">stat_ellipse</span>(</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">geom =</span> <span class="st">"polygon"</span>,</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">level =</span> <span class="fl">0.95</span>,</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> <span class="fl">0.1</span>,</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">linewidth =</span> <span class="fl">0.3</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_color_manual</span>(<span class="at">values =</span> qc_colors, <span class="at">drop =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_fill_manual</span>(<span class="at">values =</span> qc_colors, <span class="at">drop =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">scale_shape_manual</span>(<span class="at">values =</span> qc_shapes, <span class="at">drop =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme_light</span>(<span class="at">base_size =</span>  <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">xlab</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"PC1 ({round(pca_contrib[[1,'percent']]*100,1)}%)"</span>)) <span class="sc">+</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">ylab</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"PC2 ({round(pca_contrib[[2,'percent']]*100,1)}%)"</span>)) <span class="sc">+</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> ggplot2<span class="sc">::</span><span class="fu">element_line</span>(<span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="st">"grey95"</span>),</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.border =</span> ggplot2<span class="sc">::</span><span class="fu">element_rect</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"grey70"</span>),</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">aspect.ratio =</span> <span class="dv">1</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>  p</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(d_subset, conc_adj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="PHM5002-Tutorial_files/figure-html/pca-output-1.png" id="pca" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exclusion-of-an-outlier-sample" class="level2">
<h2 class="anchored" data-anchor-id="exclusion-of-an-outlier-sample">14. Exclusion of an Outlier Sample</h2>
<p>We identified a potential outlier in the PCA. After a detailed review, we determined that this outlier resulted from a technical error during sample extraction. Therefore, we excluded this sample from the dataset and re-plotted the PCA to confirm its removal and inspect the updated data structure.</p>
<div id="cell-remove-outlier" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>d_subset_filt <span class="ot">&lt;-</span> d_subset <span class="sc">|&gt;</span> <span class="fu">filter</span>(sample_id <span class="sc">!=</span> <span class="st">"LT_batch6_51"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(d_subset_filt, conc_adj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="PHM5002-Tutorial_files/figure-html/remove-outlier-output-1.png" id="remove-outlier" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="saving-the-final-dataset" class="level2">
<h2 class="anchored" data-anchor-id="saving-the-final-dataset">15. Saving the Final Dataset</h2>
<p>We now export the final, drift/batch-corrected concentration data as a wide CSV table, ready for downstream analysis.</p>
<div id="export-results" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>d_final <span class="ot">&lt;-</span> d_subset_filt <span class="sc">|&gt;</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(qc_type <span class="sc">==</span> <span class="st">"SAMPLE"</span>, <span class="sc">!</span><span class="fu">str_detect</span>(lipid, <span class="st">"ISTD"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="fu">c</span>(sample_id, qc_type), <span class="at">names_from =</span> <span class="st">"lipid"</span>, <span class="at">values_from =</span> <span class="st">"conc_adj"</span>) </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_final, <span class="fu">here</span>(<span class="st">"output/results-tg-subset.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="processing-the-full-dataset" class="level1">
<h1>Processing the Full Dataset</h1>
<p>In the following sections, we process the full dataset, rather than the illustrative subset used above. We will apply the same workflow to all measured lipid species.</p>
<section id="data-postprocessing-full-dataset" class="level2">
<h2 class="anchored" data-anchor-id="data-postprocessing-full-dataset">16. Data Postprocessing (Full Dataset)</h2>
<p>We first import a table that maps each measured lipid species with the ISTD it should be normalized with. Additionally, we import a table that defines the concentrations of the ISTD in the spiked-in ISTD mix solution. Then, we join the tables together as shown in Figure 3, then group the table into ISTD groups and proceed with normalization and quantification as described in section 8. Drift- and batch correction is performed as in section 10.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/ISTDnormquant-many.png" class="img-fluid figure-img" width="544"></p>
<figcaption><strong>Figure 3:</strong> Joining of mapped ISTD and ISTD concentrations</figcaption>
</figure>
</div>
<div id="calc-full-data" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>d_istd_map <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="fu">here</span>(<span class="st">"data/ISTD_mapping.csv"</span>),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="cn">TRUE</span>, <span class="at">trim_ws =</span> <span class="cn">TRUE</span>, <span class="at">col_types =</span> <span class="st">"c"</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>d_istd_conc <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="fu">here</span>(<span class="st">"data/ISTD_conc.csv"</span>),</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_names =</span> <span class="cn">TRUE</span>, <span class="at">trim_ws =</span> <span class="cn">TRUE</span>, <span class="at">col_types =</span> <span class="st">"c"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>d_full <span class="ot">&lt;-</span> d_full <span class="sc">|&gt;</span> </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_istd_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"lipid"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_istd_conc, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"istd"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_istd =</span> (lipid <span class="sc">==</span> istd)) <span class="sc">|&gt;</span> </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(istd, sample_id) <span class="sc">|&gt;</span> </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">norm_area =</span> area<span class="sc">/</span>area[is_istd],</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">concentration =</span> norm_area <span class="sc">*</span> istd_conc_nmolar <span class="sc">/</span> <span class="dv">1000</span> <span class="sc">*</span> <span class="fl">4.5</span> <span class="sc">/</span> <span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>d_full<span class="sc">$</span>y_predicted <span class="ot">&lt;-</span> <span class="cn">NULL</span>   <span class="co"># clean up in case chunk is rerun</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-transform concentration values to make loess more robust</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>d_full<span class="sc">$</span>conc_log <span class="ot">&lt;-</span> <span class="fu">log2</span>(d_full<span class="sc">$</span>concentration ) <span class="co"># log-transform concentration</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate loess fit for each lipid in each batch</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>d_full <span class="ot">&lt;-</span> d_full <span class="sc">|&gt;</span> </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lipid, batch_id) <span class="sc">|&gt;</span>  </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_predicted =</span> purrr<span class="sc">::</span><span class="fu">map</span>(data, \(x) <span class="fu">get_loess</span>(x))) <span class="sc">|&gt;</span> </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(data, y_predicted))</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Smooth study samples based on the loess fit of the QCs and </span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="co"># and transform values back to concentration scale</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>d_full <span class="ot">&lt;-</span> d_full <span class="sc">|&gt;</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lipid, batch_id) <span class="sc">|&gt;</span> </span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_predicted =</span> y_predicted <span class="sc">-</span> <span class="fu">median</span>(y_predicted, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">conc_adj =</span> <span class="dv">2</span><span class="sc">^</span>(conc_log <span class="sc">-</span> y_predicted)) <span class="sc">|&gt;</span> </span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Between-batch median-centering</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>d_full <span class="ot">&lt;-</span> d_full <span class="sc">|&gt;</span> </span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(lipid,  batch_id) <span class="sc">|&gt;</span> </span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">conc_adj =</span> conc_adj<span class="sc">/</span><span class="fu">median</span>(conc_adj[qc_type <span class="sc">==</span> <span class="st">"QC"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inspecting-normalized-data-full-dataset" class="level2">
<h2 class="anchored" data-anchor-id="inspecting-normalized-data-full-dataset">17. Inspecting Normalized Data (Full Dataset)</h2>
<p>As in Section 9, we plot the data as scatter plots. Because the full dataset includes many lipid species, we export a multi-page PDF containing plots for all lipids. We first define a reusable plotting function, then generate PDFs for both raw peak areas and final concentrations.</p>
<div id="runscatter-function-fulldataset" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-message="false" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>runscatter <span class="ot">&lt;-</span> <span class="cf">function</span>(data, var){</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(qc_type, <span class="st">"BLANK|RQC"</span>))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  plot_page <span class="ot">&lt;-</span> <span class="cf">function</span>(data, nrows, ncols){</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x=</span>run_no, <span class="at">y=</span>{{var}})) <span class="sc">+</span> </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>          <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> qc_type, <span class="at">fill =</span> qc_type, <span class="at">shape  =</span> qc_type),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">size =</span> <span class="dv">1</span>, <span class="at">alpha =</span><span class="fl">0.7</span>, <span class="at">stroke =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>          <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(lipid), <span class="at">ncol =</span> ncols, <span class="at">nrow =</span> nrows, <span class="at">scales=</span><span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>          <span class="fu">geom_smooth</span>(<span class="at">data=</span> <span class="fu">subset</span>(data, qc_type<span class="sc">==</span><span class="st">"BQC"</span>), <span class="fu">aes</span>(<span class="at">x=</span>run_no, <span class="at">y=</span>{{var}}), </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">span =</span> <span class="fl">0.75</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"brown3"</span>, <span class="at">linewidth =</span> .<span class="dv">7</span>)<span class="sc">+</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>          <span class="fu">scale_shape_manual</span>(<span class="at">na.value =</span> <span class="cn">NA</span>, <span class="at">values =</span> qc_shapes) <span class="sc">+</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>          <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> qc_colors, <span class="at">na.value =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>          <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> qc_colors, <span class="at">na.value =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>          <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(d_full<span class="sc">$</span>run_no), <span class="at">by =</span> <span class="dv">100</span> )) <span class="sc">+</span> </span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span> </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>          <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">8</span>) </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  rows_page <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  columns_page <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#get a table with page numbers for each lipid species</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  d_pages <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">select</span>(lipid) <span class="sc">|&gt;</span> <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">page_no =</span> <span class="fu">ceiling</span>(<span class="fu">row_number</span>() <span class="sc">/</span> (rows_page <span class="sc">*</span> columns_page)))</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">#plot each page from a nested table</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  d_plots <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(qc_type, <span class="st">"BLK|RQC"</span>), <span class="sc">!</span><span class="fu">str_detect</span>(lipid, <span class="st">"ISTD"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(d_pages, <span class="at">by =</span> <span class="st">"lipid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(page_no) <span class="sc">|&gt;</span> </span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nest</span>() <span class="sc">|&gt;</span> </span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">plt =</span> <span class="fu">map</span>(data, <span class="sc">~</span> <span class="fu">plot_page</span>(., rows_page, columns_page)))</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save pages to a PDF. </span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pdf</span>(<span class="at">file =</span> <span class="fu">here</span>(<span class="fu">paste0</span>(<span class="st">"output/runscatter_"</span>, <span class="fu">quo_name</span>(<span class="fu">enquo</span>(var)), <span class="st">".pdf"</span>)),</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">onefile =</span> <span class="cn">FALSE</span>, <span class="at">width =</span> <span class="dv">280</span><span class="sc">/</span><span class="fl">25.4</span>, <span class="at">height =</span> <span class="dv">180</span><span class="sc">/</span><span class="fl">25.4</span>)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">#d_plots$plt </span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(purrr<span class="sc">::</span><span class="fu">walk</span>(d_plots<span class="sc">$</span>plt, print)) <span class="co"># use this to prevent printing of index</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="co"># and run it twice, plotting raw areas and concentrations</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="fu">runscatter</span>(d_full, area)</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="fu">runscatter</span>(d_full, conc_adj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="runscatter-function-fulldataset-1" class="cell-output cell-output-display">
<strong>agg_record_285652944:</strong> 2
</div>
<div id="runscatter-function-fulldataset-2" class="cell-output cell-output-display">
<strong>agg_record_285652944:</strong> 2
</div>
</div>
</section>
<section id="qc-filtering-full-dataset" class="level2">
<h2 class="anchored" data-anchor-id="qc-filtering-full-dataset">18. QC-Filtering (Full Dataset)</h2>
<p>To evaluate analysis quality and filter the data, we calculate a QC metric for each lipid species and apply QC filtering using %CV &lt; 25% and a signal-to-blank ratio &gt; 10 as criteria. You can modify these parameters and see how it affects the number of species that pass/fail the filtering step. Before we calculate the QC matrics, we remove that outlier sample identified in Section 14.</p>
<div id="cell-39" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#label: qc-filt-full</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>cv <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">/</span><span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>d_full <span class="ot">&lt;-</span> d_full <span class="sc">|&gt;</span> <span class="fu">filter</span>(sample_id <span class="sc">!=</span> <span class="st">"LT_batch6_51"</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get QC metrics</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>d_qc <span class="ot">&lt;-</span> d_full<span class="sc">|&gt;</span> </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(lipid) <span class="sc">|&gt;</span> </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">signal_blank_ratio =</span> <span class="fu">median</span>(area[qc_type <span class="sc">==</span> <span class="st">"SAMPLE"</span>], <span class="at">na.rm  =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">median</span>(area[qc_type <span class="sc">==</span> <span class="st">"BLANK"</span>], <span class="at">na.rm  =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_qc_area =</span> <span class="fu">cv</span>(area[qc_type <span class="sc">==</span> <span class="st">"QC"</span>]),</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_qc_concadj =</span> <span class="fu">cv</span>(conc_adj[qc_type <span class="sc">==</span> <span class="st">"QC"</span>]), </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_sample_area =</span> <span class="fu">cv</span>(area[qc_type <span class="sc">==</span> <span class="st">"SAMPLE"</span>]),</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_sample_concadj =</span> <span class="fu">cv</span>(conc_adj[qc_type <span class="sc">==</span> <span class="st">"SAMPLE"</span>]), </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_conc =</span> <span class="fu">mean</span>(conc_adj[qc_type <span class="sc">==</span> <span class="st">"SAMPLE"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the QC metrics</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>d_qc <span class="ot">&lt;-</span> d_qc <span class="sc">|&gt;</span> </span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( </span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">qc_pass =</span> </span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>      cv_qc_concadj <span class="sc">&lt;</span> <span class="dv">25</span> <span class="sc">&amp;</span> </span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>      signal_blank_ratio <span class="sc">&gt;</span> <span class="dv">10</span> <span class="sc">&amp;</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">str_detect</span>(lipid, <span class="st">"ISTD"</span>))</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"QC filtering: "</span>, <span class="fu">nrow</span>(d_qc[d_qc<span class="sc">$</span>qc_pass, ]), <span class="st">" of "</span>, <span class="fu">nrow</span>(d_qc), <span class="st">" species passed QC"</span>))</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="co"># QC-filter dataset</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>d_filtered <span class="ot">&lt;-</span> d_full <span class="sc">|&gt;</span> </span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">semi_join</span>(d_qc, <span class="at">by =</span> <span class="st">"lipid"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>QC filtering: 319 of 413 species passed QC</code></pre>
</div>
</div>
</section>
<section id="principal-component-analysis-full-dataset" class="level2">
<h2 class="anchored" data-anchor-id="principal-component-analysis-full-dataset">19. Principal Component Analysis (Full Dataset)</h2>
<p>As in Section 13, we check the final data using PCA plots</p>
<div id="cell-pca-fulldata" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_pca</span>(d_filtered, conc_adj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="PHM5002-Tutorial_files/figure-html/pca-fulldata-output-1.png" id="pca-fulldata" width="420" height="420" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="saving-final-dataset-full-dataset" class="level2">
<h2 class="anchored" data-anchor-id="saving-final-dataset-full-dataset">20. Saving Final Dataset (Full Dataset)</h2>
<p>We save the final, drift-corrected and QC-filtered concentration data as a wide CSV table.</p>
<div id="export-results-fulldata" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;vscode&quot;,&quot;value&quot;:{&quot;languageId&quot;:&quot;r&quot;}}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>d_final <span class="ot">&lt;-</span> d_filtered <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(qc_type <span class="sc">==</span> <span class="st">"SAMPLE"</span>, <span class="sc">!</span><span class="fu">str_detect</span>(lipid, <span class="st">"ISTD"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="fu">c</span>(sample_id, qc_type), <span class="at">names_from =</span> <span class="st">"lipid"</span>, <span class="at">values_from =</span> <span class="st">"conc_adj"</span>) </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_final, <span class="fu">here</span>(<span class="st">"output/results-full.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>